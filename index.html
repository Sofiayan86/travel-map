<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的 AI 旅行地圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-900">

    <!-- 地圖容器 -->
    <div id="map"></div>

    <!-- 疊加在右上角的 UI 控制面板 -->
    <div class="absolute top-4 right-4 bg-white/80 backdrop-blur-sm shadow-lg rounded-xl p-6 w-80 text-gray-800 border border-gray-200 flex flex-col gap-4">
        <div>
            <h1 class="text-2xl font-bold mb-1">我的 AI 旅行地圖</h1>
            <p class="text-sm text-gray-600">視覺化呈現走過的世界角落</p>
        </div>
        
        <div>
            <label for="year-select" class="block text-sm font-medium text-gray-700 mb-1">篩選年份</label>
            <select id="year-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="all">顯示全部</option>
            </select>
        </div>
        
        <!-- Gemini AI 功能 -->
        <div>
             <button id="generate-story-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors shadow flex items-center justify-center gap-2">
                <span class="text-xl">✨</span> 生成旅行故事
            </button>
        </div>

        <div>
            <h2 class="text-lg font-semibold mb-2">旅行數據</h2>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span>總旅行公里數:</span>
                    <span id="total-distance" class="font-semibold">待計算</span>
                </div>
                <div class="flex justify-between">
                    <span>探索國家比例:</span>
                    <span id="country-percentage" class="font-semibold">待計算</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini AI 結果顯示 Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col transform scale-95">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">✨ AI 生成的內容</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="gemini-output" class="p-6 overflow-y-auto text-gray-700 leading-relaxed whitespace-pre-wrap">
                <!-- AI 生成的內容會顯示在這裡 -->
            </div>
        </div>
    </div>
    
    <!-- 引入 JavaScript 檔案 -->
    <script src="script.js"></script>
</body>
</html>
```css
/* style.css */
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    overflow: hidden;
}
#map {
    height: 100vh;
    width: 100vw;
}
.gm-style-iw-c {
    padding: 0 !important;
    border-radius: 12px !important;
}
.gm-style-iw-d {
    overflow: hidden !important;
}
/* Gemini AI Modal 樣式 */
#gemini-modal {
    transition: opacity 0.3s ease-in-out;
}
.modal-content {
    transition: transform 0.3s ease-in-out;
}
/* 簡易的載入中動畫 */
.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
```javascript
/* script.js */
// --- 設定與資料 ---

// 這個佔位符將在 GitHub Actions 部署過程中被替換成真實的 API 金鑰
const API_KEY = '__GOOGLE_API_KEY__';

const travelSpots = [
    { position: { lat: 48.8584, lng: 2.2945 }, title: '艾菲爾鐵塔', year: 2022, country: 'France', embedUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2624.991625694205!2d2.292292615674384!3d48.85837007928746!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47e66e2964e34e2d%3A0x8ddca9ee380ef7e0!2sEiffel%20Tower!5e0!3m2!1sen!2sfr!4v1678886' },
    { position: { lat: 35.6895, lng: 139.6917 }, title: '東京鐵塔', year: 2023, country: 'Japan', embedUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3241.383182851239!2d139.7432442152584!3d35.66693398019748!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x60188b0d01b13b71%3A0x7d68a33fee753833!2sTokyo%20Tower!5e0!3m2!1sen!2sjp!4v1678886' },
    { position: { lat: 40.7484, lng: -73.9857 }, title: '帝國大廈', year: 2024, country: 'USA', embedUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3022.536437500122!2d-73.98785368459395!3d40.74844047932827!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c259a9a9a9a9a9%3A0x5a8f4a1b65e2d6b3!2sEmpire%20State%20Building!5e0!3m2!1sen!2sus!4v1678886' },
    { position: { lat: -33.8568, lng: 151.2153 }, title: '雪梨歌劇院', year: 2023, country: 'Australia', embedUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3312.915118413985!2d151.2131089152101!3d-33.85678438065749!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x6b12ae665e892fdd%3A0x317376748a85f6e!2sSydney%20Opera%20House!5e0!3m2!1sen!2sau!4v1678886' }
];

let map, infoWindow;
const markers = [];
let visibleSpots = [];

// 動態載入 Google Maps API 的主函式
function loadGoogleMapsAPI() {
    // 檢查佔位符是否已被替換
    if (API_KEY === '__GOOGLE_API_KEY__') {
        console.error("API 金鑰未被替換。請確保 GitHub Actions 工作流程已成功執行。");
        // 可以在此處顯示一個錯誤訊息給使用者
        document.body.innerHTML = '<div style="color:red; text-align:center; padding-top: 50px;">錯誤：API 金鑰設定不正確。</div>';
        return;
    }
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap&libraries=maps,marker,core&v=beta`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Map 初始化函式，作為回呼傳遞給 Google API
window.initMap = async function() {
    const { Map } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
    
    map = new Map(document.getElementById("map"), {
        center: { lat: 10, lng: 100 }, zoom: 2, mapId: 'DEMO_MAP_ID',
        disableDefaultUI: true, zoomControl: true, streetViewControl: false, mapTypeControl: false,
    });

    infoWindow = new google.maps.InfoWindow();
    
    setupUI(AdvancedMarkerElement);
    updateMarkers();
}

function setupUI(AdvancedMarkerElement) {
    const yearSelect = document.getElementById('year-select');
    const years = [...new Set(travelSpots.map(spot => spot.year))].sort((a, b) => b - a);
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    });
    yearSelect.addEventListener('change', updateMarkers);
    
    travelSpots.forEach(spot => {
        const marker = new AdvancedMarkerElement({ position: spot.position, title: spot.title });
        marker.addListener('click', () => {
            const content = `
                <div style="width: 300px; height: 320px; display: flex; flex-direction: column;">
                    <div style="flex-grow: 1; border:0;">
                        <iframe width="100%" height="100%" style="border:0;" loading="lazy" allowfullscreen src="${spot.embedUrl}"></iframe>
                    </div>
                    <div style="padding: 10px; background: #f9f9f9;">
                        <button onclick="getAiInsights('${spot.title}')" class="w-full bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 transition-colors text-sm flex items-center justify-center gap-2">
                            <span class="text-md">✨</span> 獲取 AI 景點洞察
                        </button>
                    </div>
                </div>`;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        });
        markers.push({ marker, spot });
    });
    
    document.getElementById('generate-story-btn').addEventListener('click', generateAiStory);
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    document.getElementById('gemini-modal').addEventListener('click', (e) => {
        if (e.target.id === 'gemini-modal') closeModal();
    });
}

function updateMarkers() {
    const selectedYear = document.getElementById('year-select').value;
    const bounds = new google.maps.LatLngBounds();
    visibleSpots = [];

    markers.forEach(({ marker, spot }) => {
        const isVisible = selectedYear === 'all' || spot.year.toString() === selectedYear;
        marker.map = isVisible ? map : null;
        if (isVisible) {
            bounds.extend(spot.position);
            visibleSpots.push(spot);
        }
    });

    if (visibleSpots.length > 0) {
        map.fitBounds(bounds);
        if (map.getZoom() > 15) map.setZoom(15);
    } else {
        map.setCenter({ lat: 10, lng: 100 });
        map.setZoom(2);
    }
}

async function callGemini(prompt) {
    showModal(true); // 顯示載入中
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || 'AI 服務發生錯誤');
        }
        
        const result = await response.json();
        const text = result.candidates[0]?.content?.parts[0]?.text;
        if (text) {
            showModal(false, text);
        } else {
            throw new Error('AI 未能生成有效內容。');
        }
    } catch (error) {
        console.error("Gemini API Error:", error);
        showModal(false, `發生錯誤：\n${error.message}\n\n請檢查 API 金鑰是否正確、已啟用 Generative Language API，並且已設定正確的 HTTP 參照位址限制。`);
    }
}

function generateAiStory() {
    if (visibleSpots.length === 0) {
        alert('請先篩選出至少一個地點，才能生成故事！');
        return;
    }
    const locationNames = visibleSpots.map(spot => spot.title).join(', ');
    const prompt = `我是一位熱愛探險的旅行家，請你根據我曾去過的這些地點：${locationNames}，用第一人稱、生動活潑的語氣，為我撰寫一篇 150-200 字的短篇旅行故事，將這些地點巧妙地串連起來。`;
    callGemini(prompt);
}

window.getAiInsights = function(locationTitle) {
    const prompt = `請為我介紹「${locationTitle}」這個景點。請提供 3 個最有趣的冷知識或歷史故事，用條列式的方式呈現，讓我可以快速了解它的獨特之處。`;
    callGemini(prompt);
}

function showModal(isLoading, content = '') {
    const modal = document.getElementById('gemini-modal');
    const outputDiv = document.getElementById('gemini-output');
    
    if (isLoading) {
        outputDiv.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loader"></div></div>';
    } else {
        outputDiv.innerHTML = content;
    }
    
    modal.classList.remove('opacity-0', 'pointer-events-none');
    modal.querySelector('.modal-content').classList.remove('scale-95');
}

function closeModal() {
    const modal = document.getElementById('gemini-modal');
    modal.classList.add('opacity-0', 'pointer-events-none');
    modal.querySelector('.modal-content').classList.add('scale-95');
}

window.addEventListener('resize', () => {
    if (map && visibleSpots.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        visibleSpots.forEach(spot => bounds.extend(spot.position));
        map.fitBounds(bounds);
    }
});

// 當 DOM 載入完成後，開始載入 Google Maps API
document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
